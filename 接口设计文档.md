# VAR熔池视频分析系统 - 接口设计文档

## 1. 接口概述

### 1.1 服务端口
- **后端服务**：http://localhost:8080
- **AI处理模块**：http://localhost:5000（内部调用，前端不直接访问）
- **前端**：http://localhost:3000

### 1.2 通用规范
- **协议**：HTTP/1.1
- **数据格式**：JSON
- **编码**：UTF-8
- **响应结构**：
```json
{
  "code": 0,           // 0=成功, 非0=错误码
  "message": "success",
  "data": { ... },     // 响应数据
  "timestamp": 1696147200000
}
```

### 1.3 错误码定义
| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |
| 1001 | 视频格式不支持 |
| 1002 | 任务不存在 |
| 1003 | 任务处理失败 |

---

## 2. 后端API接口（前端调用）

### 2.1 任务管理

#### 2.1.1 上传视频并创建分析任务
**接口**：`POST /api/tasks/upload`

**请求头**：
```
Content-Type: multipart/form-data
```

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| video | File | 是 | 视频文件（支持mp4/avi/mov，最大2GB） |
| name | String | 否 | 任务名称（默认使用文件名） |
| description | String | 否 | 任务描述 |
| timeoutRatio | String | 否 | 超时比例（如"1:4"，默认"1:4"） |
| confidenceThreshold | Float | 否 | 置信度阈值（0.1~0.9，默认0.5） |
| iouThreshold | Float | 否 | IoU阈值（0.3~0.7，默认0.45） |

**上传限制**：
- 文件大小：最大 2GB (2147483648 bytes)
- 支持格式：mp4, avi, mov, mkv
- 文件格式校验：通过MIME类型和魔数验证
- 超出限制返回错误码：1001（视频格式不支持）

**响应示例**：

```json
{
  "code": 0,
  "message": "任务创建成功",
  "data": {
    "taskId": "uuid-xxx-xxx",
    "name": "实验视频_20250101.mp4",
    "status": "PENDING",
    "videoDuration": 1800,  // 视频时长（秒）
    "timeoutThreshold": 7200,  // 超时阈值（秒）
    "config": {
      "timeoutRatio": "1:4",
      "confidenceThreshold": 0.5,
      "iouThreshold": 0.45
    },
    "createdAt": "2025-10-01T10:30:00Z"
  }
}
```

---

#### 2.1.2 查询任务列表
**接口**：`GET /api/tasks`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | Integer | 否 | 页码（从0开始，默认0） |
| size | Integer | 否 | 每页数量（默认20） |
| status | String | 否 | 状态筛选（PENDING/PREPROCESSING/ANALYZING/COMPLETED/COMPLETED_TIMEOUT/FAILED） |

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "content": [
      {
        "taskId": "uuid-xxx-xxx",
        "name": "实验视频_20250101.mp4",
        "status": "COMPLETED",
        "isTimeout": false,
        "progress": 1.0,
        "videoDuration": 1800,
        "preprocessingDuration": 15,  // 预处理耗时（秒）
        "analyzingDuration": 2715,    // 分析耗时（秒）
        "totalDuration": 2730,        // 总耗时（秒）
        "timeoutThreshold": 7200,     // 超时阈值（秒）
        "createdAt": "2025-10-01T10:30:00Z",
        "startedAt": "2025-10-01T10:30:05Z",
        "preprocessingCompletedAt": "2025-10-01T10:30:20Z",
        "completedAt": "2025-10-01T11:15:30Z"
      },
      {
        "taskId": "uuid-yyy-yyy",
        "name": "实验视频_20250102.mp4",
        "status": "ANALYZING",
        "isTimeout": false,
        "progress": 0.35,
        "phase": "analyzing",
        "videoDuration": 3600,
        "preprocessingDuration": 20,
        "analyzingDuration": 3200,  // 当前已分析时长
        "timeoutThreshold": 14400,
        "createdAt": "2025-10-01T12:00:00Z",
        "startedAt": "2025-10-01T12:00:05Z",
        "preprocessingCompletedAt": "2025-10-01T12:00:25Z"
      },
      {
        "taskId": "uuid-zzz-zzz",
        "name": "实验视频_20250103.mp4",
        "status": "COMPLETED_TIMEOUT",
        "isTimeout": true,
        "progress": 1.0,
        "videoDuration": 3600,
        "preprocessingDuration": 18,
        "analyzingDuration": 17982,  // 超过了阈值
        "totalDuration": 18000,
        "timeoutThreshold": 14400,
        "createdAt": "2025-10-01T14:00:00Z",
        "completedAt": "2025-10-01T19:00:00Z"
      }
    ],
    "totalElements": 45,
    "totalPages": 3,
    "number": 0,
    "size": 20
  }
}
```

---

#### 2.1.3 查询任务详情
**接口**：`GET /api/tasks/{taskId}`

**路径参数**：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| taskId | String | 任务ID |

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "taskId": "uuid-xxx-xxx",
    "name": "实验视频_20250101.mp4",
    "status": "COMPLETED",
    "isTimeout": false,
    "progress": 1.0,
    "phase": "completed",  // preprocessing/analyzing/completed
    "videoPath": "/uploads/2025/10/01/video_xxx.mp4",
    "totalFrames": 12000,
    "processedFrames": 12000,
    "fps": 30,
    "videoDuration": 400,  // 视频时长（秒）
    "preprocessingDuration": 8,     // 预处理耗时（秒）
    "analyzingDuration": 2722,      // 分析耗时（秒）
    "totalDuration": 2730,          // 总耗时（秒）
    "timeoutThreshold": 1600,       // 超时阈值（秒）
    "config": {
      "timeoutRatio": "1:4",
      "confidenceThreshold": 0.5,
      "iouThreshold": 0.45,
      "modelVersion": "yolov11n"
    },
    "createdAt": "2025-10-01T10:30:00Z",
    "startedAt": "2025-10-01T10:30:15Z",
    "preprocessingCompletedAt": "2025-10-01T10:30:23Z",
    "completedAt": "2025-10-01T11:15:30Z"
  }
}
```

---

#### 2.1.4 获取任务实时进度
**接口**：`GET /api/tasks/{taskId}/progress`

**预处理阶段示例**：
```json
{
  "code": 0,
  "data": {
    "status": "PREPROCESSING",
    "phase": "视频预处理中",
    "progress": 0.0,
    "message": "正在解析视频元数据...",
    "elapsedTime": 5,
    "timeoutThreshold": 7200
  }
}
```

**分析阶段示例**：
```json
{
  "code": 0,
  "data": {
    "status": "ANALYZING",
    "phase": "视频分析中",
    "progress": 0.45,
    "currentFrame": 5400,
    "totalFrames": 12000,
    "preprocessingDuration": 10,      // 预处理耗时（秒）
    "analyzingElapsedTime": 1490,     // 分析已用时间（秒）
    "estimatedTimeRemaining": 1800,   // 预计剩余时间（秒）
    "timeoutThreshold": 7200,         // 超时阈值（秒）
    "isTimeout": false,               // 是否已超时
    "timeoutWarning": false           // 是否接近超时（分析时间 > 80%阈值）
  }
}
```

**超时预警示例**：
```json
{
  "code": 0,
  "data": {
    "status": "ANALYZING",
    "phase": "视频分析中",
    "progress": 0.65,
    "currentFrame": 7800,
    "totalFrames": 12000,
    "preprocessingDuration": 10,
    "analyzingElapsedTime": 5990,     // 分析已用5990秒
    "estimatedTimeRemaining": 3230,
    "timeoutThreshold": 7200,         // 阈值7200秒
    "isTimeout": false,
    "timeoutWarning": true            // 已接近超时（83%）
  }
}
```

**已超时示例**：
```json
{
  "code": 0,
  "data": {
    "status": "ANALYZING",
    "phase": "视频分析中（已超时）",
    "progress": 0.75,
    "currentFrame": 9000,
    "totalFrames": 12000,
    "preprocessingDuration": 10,
    "analyzingElapsedTime": 7490,     // 已超过阈值
    "estimatedTimeRemaining": 2500,
    "timeoutThreshold": 7200,
    "isTimeout": true,                // 已超时，但继续处理
    "timeoutWarning": true
  }
}
```

---

#### 2.1.5 删除任务
**接口**：`DELETE /api/tasks/{taskId}`

**响应示例**：
```json
{
  "code": 0,
  "message": "任务已删除"
}
```

---

### 2.2 分析结果查询

#### 2.2.1 获取动态参数数据
**接口**：`GET /api/tasks/{taskId}/metrics`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| startFrame | Integer | 否 | 起始帧号 |
| endFrame | Integer | 否 | 结束帧号 |
| interval | Integer | 否 | 数据间隔（默认1，即每帧） |

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "taskId": "uuid-xxx-xxx",
    "metrics": [
      {
        "frameNumber": 100,
        "timestamp": 3.33,  // 时间（秒）
        "flickerFrequency": 15.2,  // 闪烁频率（Hz）
        "poolArea": 45800,  // 熔池面积（像素）
        "poolPerimeter": 1250  // 熔池周长（像素）
      },
      {
        "frameNumber": 101,
        "timestamp": 3.37,
        "flickerFrequency": 15.5,
        "poolArea": 45950,
        "poolPerimeter": 1255
      }
      // ... 更多数据点
    ]
  }
}
```

---

#### 2.2.2 获取异常事件列表
**接口**：`GET /api/tasks/{taskId}/events`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| eventType | String | 否 | 事件类型筛选 |

**事件类型枚举**：
- `POOL_NOT_EDGE`：熔池未到边
- `ADHESION_FORMED`：电极形成粘连物
- `ADHESION_DROPPED`：粘连物脱落
- `CROWN_DROPPED`：锭冠脱落
- `GLOW`：辉光
- `SIDE_ARC`：边弧（侧弧）
- `CLIMBING_ARC`：爬弧

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "events": [
      {
        "eventId": "evt-001",
        "eventType": "ADHESION_FORMED",
        "eventName": "电极形成粘连物",
        "startFrame": 1500,
        "endFrame": 1500,  // 瞬时事件，起始=结束
        "startTime": 50.0,  // 时间（秒）
        "endTime": 50.0,
        "objectId": "track_12",  // ByteTrack追踪ID
        "metadata": {
          "position": {"x": 320, "y": 180},
          "boundingBox": {"x": 300, "y": 160, "w": 40, "h": 40}
        }
      },
      {
        "eventId": "evt-002",
        "eventType": "ADHESION_DROPPED",
        "eventName": "粘连物脱落",
        "startFrame": 3200,
        "endFrame": 3200,
        "startTime": 106.67,
        "endTime": 106.67,
        "objectId": "track_12",
        "metadata": {
          "dropLocation": "POOL",  // POOL=落入熔池, CRUCIBLE=被结晶器捕获
          "finalPosition": {"x": 400, "y": 350}
        }
      },
      {
        "eventId": "evt-003",
        "eventType": "GLOW",
        "eventName": "辉光",
        "startFrame": 5000,
        "endFrame": 5150,  // 持续事件
        "startTime": 166.67,
        "endTime": 171.67,
        "metadata": {
          "region": "ELECTRODE_GAP"
        }
      }
    ]
  }
}
```

---

#### 2.2.3 获取追踪物体轨迹
**接口**：`GET /api/tasks/{taskId}/tracks`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| category | String | 否 | 物体类别（ADHESION/CROWN） |

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "tracks": [
      {
        "objectId": "track_12",
        "category": "ADHESION",
        "categoryName": "粘连物",
        "firstFrame": 1500,
        "lastFrame": 3200,
        "lifespan": 56.67,  // 存在时长（秒）
        "trajectory": [
          {
            "frame": 1500,
            "time": 50.0,
            "position": {"x": 320, "y": 180},
            "boundingBox": {"x": 300, "y": 160, "w": 40, "h": 40},
            "confidence": 0.95
          },
          {
            "frame": 1501,
            "time": 50.03,
            "position": {"x": 321, "y": 181},
            "boundingBox": {"x": 301, "y": 161, "w": 40, "h": 40},
            "confidence": 0.94
          }
          // ... 更多轨迹点
        ]
      }
    ]
  }
}
```

---

### 2.3 视频访问

#### 2.3.1 获取原始视频
**接口**：`GET /api/tasks/{taskId}/video/{startTime}`

请求参数：startTime，类型为Integer，表示从第几秒开始播放，为空时从头播放

**响应**：视频文件流（Content-Type: video/mp4）

---

#### 2.3.2 获取带标注的视频（可选功能）
**接口**：`GET /api/tasks/{taskId}/annotated-video`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| showBoundingBox | Boolean | 否 | 显示检测框（默认true） |
| showTrackId | Boolean | 否 | 显示追踪ID（默认true） |
| showEvents | Boolean | 否 | 显示事件标记（默认true） |

**响应**：视频文件流

---

## 3. 后端内部接口（AI模块调用）

### 3.1 进度回调
**接口**：`POST /api/internal/tasks/{taskId}/progress`

**请求头**：
```
Content-Type: application/json
Authorization: Bearer {INTERNAL_TOKEN}  // 内部服务认证
```

**请求体**：

```json
{
  "status": "ANALYZING",  // PREPROCESSING 或 ANALYZING
  "phase": "视频分析中",   // 视频预处理中 或 视频分析中
  "currentFrame": 5400,
  "totalFrames": 12000,
  "progress": 0.45,
  "preprocessingDuration": 10,   // 预处理耗时（秒，预处理完成后才有）
  "analyzingElapsedTime": 1490,  // 分析已用时间（秒，分析阶段才有）
  "isTimeout": false  // 是否已超时
}
```

**预处理阶段请求示例**：
```json
{
  "status": "PREPROCESSING",
  "phase": "视频预处理中",
  "progress": 0.0,
  "message": "正在读取视频元数据..."
}
```

**响应示例**：

```json
{
  "code": 0,
  "message": "进度已更新"
}
```

---

### 3.2 结果提交
**接口**：`POST /api/internal/tasks/{taskId}/result`

**请求头**：
```
Content-Type: application/json
Authorization: Bearer {INTERNAL_TOKEN}
```

**请求体**：

```json
{
  "status": "COMPLETED",  // 或 COMPLETED_TIMEOUT 或 FAILED
  "isTimeout": false,  // 是否超时完成
  "preprocessingDuration": 10,   // 预处理耗时（秒）
  "analyzingDuration": 2720,     // 分析耗时（秒）
  "totalDuration": 2730,         // 总耗时（秒）
  "metrics": [
    {
      "frameNumber": 100,
      "timestamp": 3.33,
      "flickerFrequency": 15.2,
      "poolArea": 45800,
      "poolPerimeter": 1250
    }
    // ... 所有帧的数据
  ],
  "events": [
    {
      "eventType": "ADHESION_FORMED",
      "startFrame": 1500,
      "endFrame": 1500,
      "objectId": "track_12",
      "metadata": { ... }
    }
    // ... 所有事件
  ],
  "tracks": [
    {
      "objectId": "track_12",
      "category": "ADHESION",
      "firstFrame": 1500,
      "lastFrame": 3200,
      "trajectory": [ ... ]
    }
    // ... 所有追踪轨迹
  ],
  "errorMessage": null  // 失败时填写错误信息
}
```

**响应示例**：
```json
{
  "code": 0,
  "message": "结果已保存"
}
```

---

## 4. AI处理模块接口（内部HTTP API）

### 4.1 健康检查
**接口**：`GET /health`

**响应示例**：
```json
{
  "status": "healthy",
  "model_loaded": true,
  "gpu_available": true,
  "version": "1.0.0"
}
```

---

### 4.2 直接分析接口（备用方案，可不通过MQ）
**接口**：`POST /api/analyze`

**请求体**：
```json
{
  "taskId": "uuid-xxx-xxx",
  "videoPath": "/path/to/video.mp4",
  "videoDuration": 1800,
  "timeoutThreshold": 7200,
  "callbackUrl": "http://backend:8080/api/internal/tasks/{taskId}/result",
  "config": {
    "confidenceThreshold": 0.5,
    "iouThreshold": 0.45,
    "timeoutRatio": "1:4"
  }
}
```

**响应示例**：
```json
{
  "status": "accepted",
  "taskId": "uuid-xxx-xxx",
  "message": "任务已接受，开始处理"
}
```

---

## 5. RabbitMQ消息队列设计

### 5.1 任务队列
**队列名**：`video_analysis_queue`

**消息格式**：
```json
{
  "taskId": "uuid-xxx-xxx",
  "videoPath": "/uploads/2025/10/01/video_xxx.mp4",
  "videoDuration": 1800,  // 视频时长（秒）
  "timeoutThreshold": 7200,  // 超时阈值（秒）
  "callbackUrl": "http://backend:8080/api/internal/tasks/uuid-xxx-xxx/result",
  "config": {
    "model": "yolov11n",  // 模型版本
    "confidenceThreshold": 0.5,    // 置信度阈值
    "iouThreshold": 0.45,          // NMS的IoU阈值
    "timeoutRatio": "1:4"          // 超时比例
  }
}
```

**消息属性**：
- **delivery_mode**: 2（持久化）
- **priority**: 5（优先级：0-10）

---

### 5.2 进度通知队列（必须）
**队列名**：`analysis_progress_queue`

**消息格式**：
```json
{
  "taskId": "uuid-xxx-xxx",
  "progress": 0.45,
  "currentFrame": 5400,
  "totalFrames": 12000
}
```

---

## 6. Redis缓存键设计

| Key | 类型 | TTL | 说明 | 示例值 |
|-----|------|-----|------|--------|
| `task:{taskId}:status` | String | 1h | 任务状态 | "PROCESSING" |
| `task:{taskId}:progress` | Hash | 1h | 实时进度 | {"current": 5400, "total": 12000, "elapsedTime": 1500} |
| `task:{taskId}:timeout` | Hash | 动态 | 超时信息 | {"threshold": 7200, "isTimeout": false, "warning": false} |
| `task:{taskId}:result` | String(JSON) | 24h | 分析结果缓存 | {...} |
| `config:timeout_ratio` | String | - | 全局默认超时比例 | "1:4" |
| `config:confidence_threshold` | String | - | 全局默认置信度阈值 | "0.5" |

---

## 7. WebSocket接口（必须，实时推送）

### 7.1 连接端点
**端点**：`ws://localhost:8080/ws/tasks/{taskId}`

### 7.2 消息格式

**状态变更推送**：
```json
{
  "type": "STATUS_CHANGE",
  "data": {
    "status": "ANALYZING",
    "previousStatus": "PREPROCESSING",
    "message": "预处理完成，开始分析..."
  }
}
```

**进度推送**：
```json
{
  "type": "PROGRESS",
  "data": {
    "status": "ANALYZING",
    "phase": "analyzing",
    "progress": 0.45,
    "currentFrame": 5400,
    "totalFrames": 12000,
    "isTimeout": false
  }
}
```

**任务完成通知**：
```json
{
  "type": "COMPLETED",
  "data": {
    "taskId": "uuid-xxx-xxx",
    "status": "COMPLETED"
  }
}
```

---

## 8. 接口调用示例

### 8.1 前端完整流程（Vue3 + Axios）

```javascript
// 1. 上传视频
const uploadVideo = async (file) => {
  const formData = new FormData();
  formData.append('video', file);
  formData.append('name', file.name);

  const { data } = await axios.post('/api/tasks/upload', formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });

  return data.data.taskId;
};

// 2. 轮询任务进度
const pollProgress = async (taskId) => {
  const interval = setInterval(async () => {
    const { data } = await axios.get(`/api/tasks/${taskId}/progress`);
    const { status, phase, progress, isTimeout, timeoutWarning } = data.data;

    // 更新进度条和状态显示
    if (status === 'PREPROCESSING') {
      updateStatus('预处理中：' + (data.data.message || '正在准备...'));
    } else if (status === 'ANALYZING') {
      updateStatus(`分析中：${(progress * 100).toFixed(1)}%`);
      updateProgressBar(progress);

      // 超时预警
      if (timeoutWarning && !isTimeout) {
        showWarning('处理接近超时，请耐心等待...');
      } else if (isTimeout) {
        showWarning('处理已超时，但仍在继续...');
      }
    } else if (status === 'COMPLETED' || status === 'COMPLETED_TIMEOUT') {
      clearInterval(interval);
      if (status === 'COMPLETED_TIMEOUT') {
        showWarning('任务已完成，但处理时间超过预期');
      }
      loadResults(taskId);
    } else if (status === 'FAILED') {
      clearInterval(interval);
      console.error('任务失败');
    }
  }, 2000);
};

// 3. 加载分析结果
const loadResults = async (taskId) => {
  const [metrics, events] = await Promise.all([
    axios.get(`/api/tasks/${taskId}/metrics`),
    axios.get(`/api/tasks/${taskId}/events`)
  ]);

  renderCharts(metrics.data.data);
  renderEventTimeline(events.data.data);
};
```

---

### 8.2 AI模块处理流程（Flask + requests）

```python
import requests
from analysis_engine import analyze_video

import time

def process_task(message):
    task_id = message['taskId']
    video_path = message['videoPath']
    callback_url = message['callbackUrl']
    timeout_threshold = message['timeoutThreshold']

    preprocessing_start = time.time()

    try:
        # 1. 预处理阶段
        update_status(task_id, 'PREPROCESSING', '正在读取视频元数据...')
        video_info = preprocess_video(video_path)
        preprocessing_duration = time.time() - preprocessing_start

        # 2. 分析阶段
        update_status(task_id, 'ANALYZING', '开始分析...')
        analyzing_start = time.time()

        result = analyze_video(
            video_path=video_path,
            video_info=video_info,
            on_progress=lambda p: update_progress(
                task_id,
                p,
                preprocessing_duration,
                time.time() - analyzing_start,
                timeout_threshold
            )
        )

        analyzing_duration = time.time() - analyzing_start
        is_timeout = analyzing_duration > timeout_threshold

        # 3. 提交结果
        requests.post(
            callback_url,
            json={
                'status': 'COMPLETED_TIMEOUT' if is_timeout else 'COMPLETED',
                'isTimeout': is_timeout,
                'preprocessingDuration': preprocessing_duration,
                'analyzingDuration': analyzing_duration,
                'totalDuration': preprocessing_duration + analyzing_duration,
                'metrics': result['metrics'],
                'events': result['events'],
                'tracks': result['tracks']
            },
            headers={'Authorization': f'Bearer {INTERNAL_TOKEN}'}
        )
    except Exception as e:
        # 提交失败信息
        requests.post(callback_url, json={
            'status': 'FAILED',
            'errorMessage': str(e)
        })

def update_status(task_id, status, message):
    """更新任务状态"""
    requests.post(
        f'http://backend:8080/api/internal/tasks/{task_id}/progress',
        json={
            'status': status,
            'phase': status.lower(),
            'message': message
        },
        headers={'Authorization': f'Bearer {INTERNAL_TOKEN}'}
    )

def update_progress(task_id, progress_data, preprocessing_duration,
                   analyzing_elapsed, timeout_threshold):
    """更新分析进度"""
    is_timeout = analyzing_elapsed > timeout_threshold
    timeout_warning = analyzing_elapsed > timeout_threshold * 0.8

    requests.post(
        f'http://backend:8080/api/internal/tasks/{task_id}/progress',
        json={
            'status': 'ANALYZING',
            'phase': 'analyzing',
            'preprocessingDuration': preprocessing_duration,
            'analyzingElapsedTime': analyzing_elapsed,
            'isTimeout': is_timeout,
            'timeoutWarning': timeout_warning,
            **progress_data
        },
        headers={'Authorization': f'Bearer {INTERNAL_TOKEN}'}
    )
```

---

## 9. 接口版本管理

### 9.1 版本策略
- **当前版本**：v1.1
- **URL前缀**： `/api/v1`
- **版本升级规则**：
  - 破坏性更改：发布新版本（如 `/api/v2`）
  - 兼容性更改：在当前版本迭代

### 9.2 弃用通知
在响应头中添加弃用警告：
```
Deprecation: true
Sunset: Sat, 31 Dec 2025 23:59:59 GMT
Link: <https://docs.example.com/api/v2>; rel="successor-version"
```

---

### 2.4 报告导出（必选功能）

#### 2.4.1 导出PDF报告
**接口**：`GET /api/tasks/{taskId}/export/pdf`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| includeCharts | Boolean | 否 | 是否包含图表（默认true） |
| includeEvents | Boolean | 否 | 是否包含异常事件列表（默认true） |
| includeTrajectory | Boolean | 否 | 是否包含轨迹图（默认false） |

**响应**：PDF文件流（Content-Type: application/pdf）

**文件名**：`VAR分析报告_{任务名称}_{时间戳}.pdf`

---

#### 2.4.2 导出Excel报告
**接口**：`GET /api/tasks/{taskId}/export/excel`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| includeMetrics | Boolean | 否 | 是否包含动态参数数据（默认true） |
| includeEvents | Boolean | 否 | 是否包含异常事件数据（默认true） |
| includeTracks | Boolean | 否 | 是否包含追踪轨迹数据（默认false） |

**响应**：Excel文件流（Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet）

**文件名**：`VAR分析数据_{任务名称}_{时间戳}.xlsx`

**Excel结构**：
- **Sheet1: 动态参数**
  - 列：帧号 | 时间(秒) | 闪烁频率(Hz) | 熔池面积(像素) | 熔池周长(像素)
- **Sheet2: 异常事件**
  - 列：事件类型 | 开始帧 | 结束帧 | 开始时间 | 结束时间 | 详细信息
- **Sheet3: 追踪轨迹**
  - 列：物体ID | 类别 | 首次出现帧 | 最后出现帧 | 存在时长(秒)

---

## 10. 系统配置管理接口

### 10.1 获取全局配置
**接口**：`GET /api/config`

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "timeoutRatio": "1:4",
    "confidenceThreshold": 0.5,
    "iouThreshold": 0.45,
    "modelVersion": "yolov11n",
    "maxVideoSize": 2147483648,  // 最大视频大小（字节，2GB）
    "supportedFormats": ["mp4", "avi", "mov"]
  }
}
```

---

### 10.2 更新全局配置
**接口**：`PUT /api/config`

**请求体**：
```json
{
  "timeoutRatio": "2:5",
  "confidenceThreshold": 0.6,
  "iouThreshold": 0.5
}
```

**响应示例**：
```json
{
  "code": 0,
  "message": "配置已更新",
  "data": {
    "timeoutRatio": "2:5",
    "confidenceThreshold": 0.6,
    "iouThreshold": 0.5
  }
}
```

---

### 10.3 超时比例预设
系统提供常用的超时比例预设：

| 预设名称 | 比例 | 说明 | 适用场景 |
|---------|------|------|----------|
| relaxed | 1:8 | 非常宽松 | GPU性能较差、高分辨率视频 |
| normal | 1:4 | 正常（默认） | 一般场景 |
| moderate | 2:5 | 适中 | GPU性能较好 |
| strict | 1:2 | 严格 | 高性能GPU、低分辨率视频 |

**使用示例**：

```json
{
  "timeoutRatio": "normal"  // 或直接使用 "1:4"
}
```

---

### 10.4 配置验证规则
- **timeoutRatio**：
  - 格式：`{分子}:{分母}`
  - 分子范围：1-10
  - 分母范围：1-20
  - 示例：`1:4`, `2:5`, `3:8`

- **confidenceThreshold**：
  - 类型：Float
  - 范围：0.1 ~ 0.9
  - 步长：0.1

- **iouThreshold**：
  - 类型：Float
  - 范围：0.3 ~ 0.7
  - 步长：0.05

---

## 11. 可选扩展接口

以下接口为可选功能，可在后续版本中实现：

### 11.1 用户管理与认证（可选）

#### 11.1.1 用户注册
**接口**：`POST /api/auth/register`

**请求体**：
```json
{
  "username": "user123",
  "password": "password123",
  "email": "user@example.com"
}
```

---

#### 11.1.2 用户登录
**接口**：`POST /api/auth/login`

**请求体**：
```json
{
  "username": "user123",
  "password": "password123"
}
```

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 86400,  // 24小时
    "user": {
      "id": "user-id-xxx",
      "username": "user123",
      "email": "user@example.com"
    }
  }
}
```

**说明**：启用JWT认证后，所有API请求需在请求头添加：
```
Authorization: Bearer {token}
```

---

### 11.2 实时视频流分析（可选）

#### 11.2.1 创建流分析任务
**接口**：`POST /api/stream/tasks`

**请求体**：
```json
{
  "streamUrl": "rtsp://example.com/live/stream1",
  "protocol": "RTSP",  // RTSP/RTMP
  "duration": 600,  // 分析时长（秒），0表示持续分析
  "config": {
    "confidenceThreshold": 0.5,
    "iouThreshold": 0.45
  }
}
```

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "taskId": "stream-task-xxx",
    "status": "STREAMING",
    "startedAt": "2025-10-01T10:30:00Z"
  }
}
```

---

#### 11.2.2 获取流分析实时结果
**接口**：`GET /api/stream/tasks/{taskId}/events`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| since | Long | 否 | 获取指定时间戳之后的事件（毫秒） |
| limit | Integer | 否 | 最多返回数量（默认100） |

---

### 11.3 模型版本管理（可选）

#### 11.3.1 获取可用模型列表
**接口**：`GET /api/models`

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "models": [
      {
        "id": "yolov11n",
        "name": "YOLOv11 Nano",
        "version": "1.0.0",
        "size": "6.2MB",
        "performance": "fast",
        "accuracy": "medium",
        "isDefault": true
      },
      {
        "id": "yolov11s",
        "name": "YOLOv11 Small",
        "version": "1.0.0",
        "size": "20MB",
        "performance": "medium",
        "accuracy": "high",
        "isDefault": false
      }
    ]
  }
}
```

---

#### 11.3.2 切换默认模型
**接口**：`PUT /api/models/{modelId}/set-default`

---

### 11.4 性能监控接口（可选）

#### 11.4.1 获取系统性能指标
**接口**：`GET /api/metrics/system`

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "timestamp": 1696147200000,
    "backend": {
      "cpuUsage": 45.2,
      "memoryUsage": 68.5,
      "activeConnections": 12
    },
    "aiProcessor": {
      "gpuUsage": 85.3,
      "gpuMemoryUsage": 72.1,
      "queueSize": 3,
      "avgProcessingTime": 2450  // 秒
    },
    "rabbitmq": {
      "queueDepth": 5,
      "messagesPerSecond": 0.5
    }
  }
}
```

---

#### 11.4.2 获取任务处理统计
**接口**：`GET /api/metrics/tasks`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| startDate | String | 否 | 起始日期（ISO 8601格式） |
| endDate | String | 否 | 结束日期（ISO 8601格式） |

**响应示例**：
```json
{
  "code": 0,
  "data": {
    "totalTasks": 156,
    "completedTasks": 142,
    "timeoutTasks": 8,
    "failedTasks": 6,
    "avgProcessingTime": 2680,  // 秒
    "avgPreprocessingTime": 12,
    "avgAnalyzingTime": 2668
  }
}
```

---

## 12. 接口测试

### 12.1 测试工具
- **Postman**：手动测试
- **JUnit + MockMvc**：后端单元测试
- **pytest + requests**：AI模块集成测试

### 12.2 测试用例（Postman Collection）

```json
{
  "info": {
    "name": "VAR熔池分析系统API测试",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "上传视频",
      "request": {
        "method": "POST",
        "url": "{{base_url}}/api/tasks/upload",
        "body": {
          "mode": "formdata",
          "formdata": [
            {
              "key": "video",
              "type": "file",
              "src": "test_video.mp4"
            }
          ]
        }
      }
    }
  ]
}
```

---

## 13. 安全性说明

### 13.1 必选安全措施

#### 13.1.1 视频上传安全
- **文件大小限制**：最大2GB
- **格式校验**：
  - MIME类型检查：`video/mp4`, `video/x-msvideo`, `video/quicktime`
  - 魔数验证：检查文件头字节确认真实格式
  - 扩展名白名单：`.mp4`, `.avi`, `.mov`
- **恶意文件防护**：
  - 上传后重命名文件（UUID）
  - 禁止执行权限
  - 独立存储目录，与应用代码隔离

#### 13.1.2 敏感信息保护
- **环境变量配置**：
  ```bash
  # 数据库配置
  DB_HOST=localhost
  DB_PORT=5432
  DB_NAME=var_analysis
  DB_USERNAME=postgres
  DB_PASSWORD=your_password_here
  
  # Redis配置
  REDIS_HOST=localhost
  REDIS_PORT=6379
  REDIS_PASSWORD=your_redis_password
  
  # RabbitMQ配置
  RABBITMQ_HOST=localhost
  RABBITMQ_PORT=5672
  RABBITMQ_USERNAME=guest
  RABBITMQ_PASSWORD=your_rabbitmq_password
  
  # 内部服务认证Token
  INTERNAL_TOKEN=your_internal_token_here
  ```

- **配置加载**：
  - 后端：Spring Boot使用`@Value`注解或`application.yml`的`${}`占位符
  - AI模块：Python使用`os.getenv()`或`python-dotenv`

#### 13.1.3 请求安全
- **CORS配置**：限制允许的域名
- **请求频率限制**：防止暴力上传（如每IP每小时最多10个任务）
- **文件路径遍历防护**：严格校验文件路径参数

---

### 13.2 可选安全措施

#### 13.2.1 JWT Token认证（可选）
启用后，所有API请求需携带JWT Token：

**请求头**：

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Token过期处理**：

- 过期时间：24小时（可配置）
- 刷新机制：提供`/api/auth/refresh`接口
- 过期响应：返回401 Unauthorized

#### 13.2.2 HTTPS强制（生产环境推荐）
- Nginx配置强制HTTPS重定向
- 证书：Let's Encrypt免费证书或商业证书

---

## 14. 接口优先级规划

基于系统设计文档的必选/可选标记，接口实现优先级如下：

### P0（必须实现）
- ✅ 任务管理接口（上传、查询、删除）
- ✅ 分析结果查询接口（动态参数、异常事件、追踪轨迹）
- ✅ 视频访问接口
- ✅ 报告导出接口（PDF/Excel）
- ✅ 系统配置管理接口
- ✅ 内部回调接口（进度、结果）
- ✅ 视频上传安全限制
- ✅ 敏感信息环境变量配置

### P1（后续优化）
- 🔲 WebSocket实时推送
- 🔲 带标注的视频导出
- 🔲 性能监控接口
- 🔲 任务处理统计

### P2（扩展功能）
- 🔲 用户管理与JWT认证
- 🔲 实时视频流分析
- 🔲 模型版本管理
- 🔲 HTTPS强制

---

**文档版本**：v1.1
**更新日期**：2025-10-01
**维护者**：侯阳洋
**变更说明**：

- v1.1: 新增报告导出接口、安全性说明、接口优先级规划
- v1.0: 初始版本